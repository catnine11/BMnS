<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gd.bmss.mapper.BookManageDaoImpl">

<!-- 알리아스 : BInfoVo -->

<resultMap type="com.gd.bmss.vo.BookInfoVo" id="bInfoMap">
	<result column="BOOK_CODE" property="book_code"/>
	<result column="ISBN" property="isbn"/>
	<result column="TITLE" property="title"/>
	<result column="AUTHOR" property="author"/>
	<result column="GENRE_CODE" property="genre_code"/>
	<result column="PUBLISHER" property="publisher"/>
	<result column="PRICE" property="price"/>
	<result column="PUBLISH_DATE" property="publish_date"/>
	<result column="THUMBNAIL" property="thumbnail"/>
	<result column="CONTENT" property="content"/>
	<result column="INTRO" property="intro"/>
	<result column="REVIEW" property="review"/>
	<result column="AUTHORINFO" property="authorinfo"/>
	<result column="GENRE_NAME" property="genre_name"/>
	
	<collection property="bsVo" resultMap="bStatusMap"/>
</resultMap>

<resultMap type="com.gd.bmss.vo.Book_StatusVo" id="bStatusMap">
	<result column="STATUS" property="status"/>
	<result column="STATUS_CODE" property="status_code"/>
	<result column="BOOK_SEQ" property="book_seq"/>
	<result column="STATUS_TITLE" property="status_title"/>
	<result column="BOOK_CODE" property="book_code"/>
	
<!-- 	<collection property="borwVo" resultMap=""/> -->
<!-- 	<collection property="resvVo" resultMap=""/> -->
</resultMap>


<!-- 전체조회(장르별) /회원 -->
<select id="getAllBookUser" resultMap="bInfoMap">
	SELECT GENRE_NAME, THUMBNAIL , AUTHOR, TITLE, PUBLISHER, BOOK_CODE
	FROM (
			SELECT GENRE_CODE, GENRE_NAME, ISBN, TITLE, AUTHOR, PUBLISHER, PUBLISH_DATE, THUMBNAIL, BOOK_CODE
			FROM BOOKINFO b JOIN BOOK_GENRE bg 
			USING (GENRE_CODE)
		)
	ORDER BY PUBLISH_DATE DESC 
</select>

<select id="getAllBookUserGenre" resultMap="bInfoMap">
	SELECT GENRE_NAME, THUMBNAIL , AUTHOR, TITLE, PUBLISHER, BOOK_CODE
	FROM (
			SELECT GENRE_CODE, GENRE_NAME, ISBN, TITLE, AUTHOR, PUBLISHER, PUBLISH_DATE, THUMBNAIL, BOOK_CODE
			FROM BOOKINFO b JOIN BOOK_GENRE bg 
			USING (GENRE_CODE)
		)
	WHERE GENRE_NAME = #{genre_name}
	ORDER BY PUBLISH_DATE DESC 
</select>

<!-- 전체조회(장르별) /관리자 -->
<select id="getAllBookAdmin" resultMap="bInfoMap">
	SELECT BOOK_CODE, GENRE_CODE, GENRE_NAME, ISBN, TITLE, AUTHOR, PUBLISHER, PUBLISH_DATE, THUMBNAIL
	FROM BOOKINFO b JOIN BOOK_GENRE bg 
	USING (GENRE_CODE)
	ORDER BY BOOK_CODE, GENRE_CODE 
</select>

<!-- 상세조회 -->
<select id="getOneBook" resultMap="bInfoMap">
<!-- 	SELECT BOOK_CODE, ISBN, TITLE, AUTHOR, bg.GENRE_NAME, PUBLISHER, PUBLISH_DATE, THUMBNAIL, CONTENT, INTRO, REVIEW, AUTHORINFO -->
<!-- 	FROM BOOKINFO bi JOIN BOOK_GENRE bg  -->
<!-- 	USING (GENRE_CODE) -->
<!-- 	WHERE BOOK_CODE=#{book_code} -->
	SELECT BOOK_CODE, BOOK_SEQ, STATUS_CODE, THUMBNAIL,
			ISBN, TITLE, AUTHOR, GENRE_NAME, GENRE_CODE, PUBLISHER, TO_CHAR(PUBLISH_DATE,'YYYY-MM-DD') AS PUBLISH_DATE , 
			CONTENT, INTRO, REVIEW, AUTHORINFO,
			BORROW_STATUS, RESERVE_STATUS
		FROM BOOKINFO 
		JOIN BOOK_GENRE bg USING (GENRE_CODE)
		JOIN BOOK_STATUS bs USING (BOOK_CODE)
		LEFT JOIN BOOK_BORROW bb USING (BOOK_SEQ)
		LEFT JOIN BOOK_RESERVE br USING (BOOK_SEQ)
		WHERE BOOK_CODE='1'
		ORDER BY BOOK_CODE
</select>

<!-- 장르변경 -->
<update id="changeGenre" parameterType="java.util.Map">
	UPDATE BOOKINFO
	SET GENRE_CODE=#{genre_code}
	WHERE BOOK_CODE IN
	<foreach collection="codes" item="book_code" open="(" separator="," close=")">
		#{book_code}
	</foreach>
</update>

<!-- 상태변경 -->
<update id="changeBStatus" parameterType="java.util.Map">
	UPDATE BOOK_STATUS
	SET STATUS_CODE=#{status_code}
	WHERE BOOK_SEQ IN
	<foreach collection="seqs" item="book_seq" open="(" separator="," close=")">
		#{book_seq}
	</foreach>
</update>

<!-- 도서등록 -->


<!-- 크롤링-도서등록 -->
<update id="updateBook" parameterType="BInfoVo">
	UPDATE BOOKINFO 
	SET CONTENT=#{content}, INTRO=#{intro}, REVIEW=#{review}, AUTHORINFO=#{authorinfo}
	WHERE BOOK_CODE=#{book_code}
</update>


</mapper>
